import os
import pandas as pd
import openpyxl
import time

def extract_car_name(sheet):
    car_name = None
    for row in sheet.iter_rows(values_only=True):
        for cell in row:
            if cell:
                car_name = cell
                return car_name
    return car_name

def extract_vru_headform_data(sheet):
    prediction_column = None
    percentage_column = None
    data_start_row = None
    extracted_data = []
    
    for row_idx, row in enumerate(sheet.iter_rows(values_only=True)):
        if "PREDICTION" in row:
            prediction_column = row.index("PREDICTION")
            if "%-age" in row:
                percentage_column = row.index("%-age")
                data_start_row = row_idx
                break

    if prediction_column is not None and percentage_column is not None and data_start_row is not None:
        for row in sheet.iter_rows(min_row=data_start_row+1, max_row=data_start_row+10, values_only=True):
            extracted_data.append(row[prediction_column:percentage_column+1])
    
    return extracted_data

root_directory = "Euro NCAP"
output_directory = "Extracted Data/VRU Headform (C) - Color-wise data"

if not os.path.exists(output_directory):
    os.makedirs(output_directory)

start_time = time.time()

for folder in os.listdir(root_directory):
    folder_path = os.path.join(root_directory, folder)
    
    if os.path.isdir(folder_path):
        output_file_name = f"{folder.split()[0]}_combined_data.xlsx"
        output_file_path = os.path.join(output_directory, output_file_name)
        
        car_names = ["Car Names"]
        combined_data = []
        
        for file in os.listdir(folder_path):
            if file.endswith(".xlsx"):
                file_path = os.path.join(folder_path, file)
                try:
                    overall_rating_sheet = pd.read_excel(file_path, sheet_name='OVERALL RATING')
                    vru_headform_sheet = pd.read_excel(file_path, sheet_name='VRU Headform')
                    
                    car_name = extract_car_name(overall_rating_sheet)
                    vru_headform_data = extract_vru_headform_data(vru_headform_sheet)
                    
                    if car_name:
                        car_names.append(car_name)
                        combined_data.append(vru_headform_data)
                        
                        print(f"Extracted car name: {car_name}")
                        print("Extracted VRU Headform data:")
                        for row in vru_headform_data:
                            print(row)
                
                except Exception as e:
                    print(f"Failed to process file {file_path}: {e}")
        
        # Create the output DataFrame
        output_df = pd.DataFrame(combined_data)
        output_df.insert(0, "Car Names", car_names)
        
        # Save to Excel
        with pd.ExcelWriter(output_file_path) as writer:
            output_df.to_excel(writer, index=False)
        
        print(f"Created output file: {output_file_path}")

end_time = time.time()
execution_time = end_time - start_time

print(f"Processing complete. Execution time: {execution_time} seconds.")
