import os
import pandas as pd
import openpyxl
import time
import logging

# Set up logging configuration
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def extract_first_word(sheet):
    # Extract the first word from the "OVERALL RATING" sheet
    for row in sheet.iter_rows():
        for cell in row:
            if cell.value:
                return str(cell.value).split()[0]
    return None

def extract_vru_headform_data(sheet):
    # Extract the data from the "VRU Headform" sheet between "PREDICTION" and "%-age"
    prediction_cell = None
    percentage_cell = None
    for row in sheet.iter_rows():
        for cell in row:
            if cell.value == "PREDICTION":
                prediction_cell = cell
            elif cell.value == "%-age":
                percentage_cell = cell
            if prediction_cell and percentage_cell:
                break
    
    if prediction_cell and percentage_cell:
        start_row = prediction_cell.row
        start_col = prediction_cell.column
        end_col = percentage_cell.column
        data = [
            [sheet.cell(row=i, column=j).value for j in range(start_col, end_col + 1)]
            for i in range(start_row, start_row + 10)
        ]
        return data
    return None

def extract_data_from_excel(file_path):
    try:
        # Load the workbook and sheets
        workbook = openpyxl.load_workbook(file_path, data_only=True)
        
        # Extract the first word from the "OVERALL RATING" sheet
        if "OVERALL RATING" in workbook.sheetnames:
            overall_rating_sheet = workbook["OVERALL RATING"]
            first_word = extract_first_word(overall_rating_sheet)
        else:
            return None, None

        # Extract the data from the "VRU Headform" sheet
        if "VRU Headform" in workbook.sheetnames:
            vru_headform_sheet = workbook["VRU Headform"]
            data = extract_vru_headform_data(vru_headform_sheet)
        else:
            return first_word, None

        return first_word, data
    except Exception as e:
        logging.error(f"Error processing {file_path}: {e}")
        return None, None

def adjust_column_widths(file_path):
    # Adjust column widths to fit the contents
    wb = openpyxl.load_workbook(file_path)
    ws = wb.active
    
    for col in ws.columns:
        max_length = 0
        column = col[0].column_letter  # Get the column name
        for cell in col:
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(cell.value)
            except:
                pass
        adjusted_width = (max_length + 2) * 1.2
        ws.column_dimensions[column].width = adjusted_width

    wb.save(file_path)

def main():
    # Define the root and output directories
    root_directory = "Euro NCAP"
    output_directory = "Extracted Data/VRU Headform (C) - Color-wise data"

    # Ensure the output directory exists
    if not os.path.exists(output_directory):
        os.makedirs(output_directory)

    start_time = time.time()

    # Iterate through each folder in the root directory
    for folder_name in os.listdir(root_directory):
        folder_path = os.path.join(root_directory, folder_name)
        
        # Ensure it's a directory
        if os.path.isdir(folder_path):
            first_word_of_folder = folder_name.split()[0]
            output_file = os.path.join(output_directory, f"{first_word_of_folder}_cars_combined.xlsx")
            
            # Initialize a DataFrame to collect all data
            combined_df = pd.DataFrame()

            # Placeholder for column names
            column_names = ["Car Names"]

            # Walk through the directory tree within the folder
            for subdir, dirs, files in os.walk(folder_path):
                for file in files:
                    if file.endswith('.xlsx') or file.endswith('.xls'):
                        file_path = os.path.join(subdir, file)
                        first_word, data = extract_data_from_excel(file_path)
                        if first_word and data:
                            df = pd.DataFrame(data)
                            if not df.empty:
                                df.columns = df.iloc[0]
                                df = df[1:]
                                df = df.dropna(how='all').dropna(axis=1, how='all')

                                # Print the extracted table (df) every time
                                print(f"\nExtracted Table from file {file}:")
                                print(df)
                                
                                # Capture the values from the second column of the extracted table
                                if len(column_names) == 1 and len(df.columns) > 1:
                                    column_names.extend(df.iloc[:, 1].tolist())
                                column_names[-1]="Predicted headform score (excluding blue points)"
                                
                                # Append the first word and the last column of the extracted table as a new row
                                # Multiply the last column values by 100 before adding to new_row
                                new_row = [first_word] + [value * 100 for value in df.iloc[:, -1].tolist()]
                                combined_df = pd.concat([combined_df, pd.DataFrame([new_row])], ignore_index=True)

            # Print the combined DataFrame before saving to Excel
            if not combined_df.empty:
                if len(column_names) < combined_df.shape[1]:
                    # Extend column names with default names if not enough provided
                    column_names.extend([f"Column {i+1}" for i in range(len(column_names), combined_df.shape[1])])
                combined_df.columns = column_names[:combined_df.shape[1]]  # Ensure exact match

                # Print the combined DataFrame and column names
                print(f"\nCombined DataFrame for {folder_name}:")
                print(combined_df)
                print(f"Column names: {combined_df.columns.tolist()}")

                # Round numerical values to 2 decimal places
                combined_df = combined_df.round(2)

                # Save the combined data to the "Data" sheet
                with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
                    combined_df.to_excel(writer, sheet_name="Data", index=False)
                
                # Adjust column widths
                adjust_column_widths(output_file)

            logging.info(f"Data extraction complete for {folder_name}. Results saved in {output_file}.")

    end_time = time.time()
    execution_time = end_time - start_time
    logging.info(f"\nScript executed in {execution_time:.2f} seconds.")

if __name__ == "__main__":
    main()
