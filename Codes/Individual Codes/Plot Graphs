import pandas as pd
import matplotlib.pyplot as plt
import os
from openpyxl import Workbook
from openpyxl.drawing.image import Image
from io import BytesIO
import numpy as np
import time

# Set input and output folder paths
input_folder = 'Extracted Data/VRU Headform - Color-wise data'
output_folder = 'Extracted Data/VRU Headform - Color-wise graphs'

# Create output folder if it doesn't exist
os.makedirs(output_folder, exist_ok=True)

# Start timing the execution
start_time = time.time()

# Loop through each Excel file in the input folder
for file_name in os.listdir(input_folder):
    if file_name.endswith('.xlsx'):
        file_path = os.path.join(input_folder, file_name)
        
        # Read Excel file
        df = pd.read_excel(file_path)
        
        # Create a new Workbook
        wb = Workbook()
        wb.remove(wb.active)  # Remove the default sheet
        
        # Create a sheet named 'Graphs'
        ws = wb.create_sheet(title='Graphs')
        
        # Initial positions for the first graph
        row_position = 1
        col_position = 1
        
        # Constants to control the layout
        max_cols = 2  # Number of columns
        row_increment = 30  # Number of rows between graphs
        col_increment = 10  # Number of columns between graphs
        
        # Generate scatter plots
        for i, col in enumerate(df.columns[1:]):
            fig, ax = plt.subplots()
            scatter = ax.scatter(df[df.columns[0]], df[col], label=col, s=8, c='red')  # Set marker size to 8 and color to red
            
            # Calculate the average value for the y-axis
            avg_value = df[col].mean()
            
            # Plot the average value as a horizontal orange line
            ax.axhline(y=avg_value, color='orange', linestyle='-', label=f'Average: {avg_value:.2f}')
            
            ax.set_xlabel(df.columns[0], fontsize=10)  # Reduce x-axis label font size
            ax.set_ylabel('%-age', fontsize=10)  # Set y-axis label to '%-age'
            ax.set_title(f'{col}', fontsize=12)  # Reduce title font size
            ax.xaxis.set_tick_params(rotation=90, labelsize=6)  # Reduce x-axis label font size
            ax.yaxis.set_tick_params(labelsize=8)  # Reduce y-axis label font size
            ax.legend(fontsize=8)  # Adjust legend font size
            
            # Adjust layout to make sure labels are fully visible
            plt.tight_layout()
            
            # Save plot to a BytesIO object
            img_stream = BytesIO()
            plt.savefig(img_stream, format='png', bbox_inches='tight')  # Use bbox_inches='tight' to crop extra whitespace
            plt.close(fig)
            
            # Add image to Excel in the 'Graphs' sheet
            img_stream.seek(0)
            img = Image(img_stream)
            
            # Calculate anchor position for the image
            img.anchor = ws.cell(row=row_position, column=col_position).coordinate
            ws.add_image(img)
            
            # Update row and column positions for the next graph
            if (i + 1) % max_cols == 0:
                row_position += row_increment  # Move to the next row block after filling max_cols
                col_position = 1  # Reset to the first column
            else:
                col_position += col_increment  # Move to the next column

        # Save Excel file with graphs
        output_file_path = os.path.join(output_folder, file_name)
        wb.save(output_file_path)

# End timing the execution
end_time = time.time()
execution_time = end_time - start_time

print(f"Graphs have been added to the same sheet named 'Graphs' in the Excel files arranged in three columns without overlapping.")
print(f"Execution time: {execution_time:.2f} seconds")
